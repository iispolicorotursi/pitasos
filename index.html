<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PitaSOS</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
      body {
        font-family: "Nunito", sans-serif;
        background-color: #f8f9fa;
        padding: 1rem;
      }
      .main-container {
        max-width: 950px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        font-weight: 700;
        color: #0d6efd;
        margin-bottom: 1.5rem;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .table th,
      .table td {
        vertical-align: middle !important;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Intestazione PitaSOS -->
      <div class="text-center mt-4 mb-4">
        <i
          class="bi bi-person-lines-fill text-primary"
          style="font-size: 3rem"
        ></i>
        <h1 class="fw-bold mb-1 mt-2">PitaSOS</h1>
        <p class="text-muted fst-italic mb-0">
          Versione per chi si occupa delle sostituzioni
        </p>
      </div>

      <!-- Selezione Data -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white fw-semibold">
          1. Seleziona la data
        </div>
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row align-items-md-end gap-3">
            <div class="flex-fill">
              <label for="date-input" class="form-label fw-semibold"
                >Data:</label
              >
              <input type="date" class="form-control" id="date-input" />
            </div>
            <div>
              <button id="load-btn" class="btn btn-primary px-4">
                <i class="bi bi-download"></i> Leggi dati
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Risultati -->
      <div id="results-container">
        <div class="alert alert-info text-center mb-0">
          I risultati verranno mostrati qui dopo la lettura dei dati.
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.getElementById("date-input");
        const loadBtn = document.getElementById("load-btn");
        const resultsContainer = document.getElementById("results-container");

        // Imposta la data odierna come predefinita
        const oggi = new Date();
        const yyyy = oggi.getFullYear();
        const mm = String(oggi.getMonth() + 1).padStart(2, "0");
        const dd = String(oggi.getDate()).padStart(2, "0");
        dateInput.value = `${yyyy}-${mm}-${dd}`;

        const csvBase = "https://progetti.antoniofittipaldi.it/pitasos/";
        const corsProxy = "https://api.allorigins.win/raw?url=";
        const orarioFile = "orario.csv";
        const abbrevMap = ["dom", "lun", "mar", "mer", "gio", "ven", "sab"];
        const giorniEstesi = [
          "Domenica",
          "LunedÃ¬",
          "MartedÃ¬",
          "MercoledÃ¬",
          "GiovedÃ¬",
          "VenerdÃ¬",
          "Sabato",
        ];
        let scheduleData = [];

        // --- Utility per leggere CSV in sicurezza ---
        async function fetchCSV(url) {
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.text();
          } catch {
            const proxyResponse = await fetch(
              corsProxy + encodeURIComponent(url)
            );
            if (!proxyResponse.ok)
              throw new Error(`Proxy ${proxyResponse.status}`);
            return await proxyResponse.text();
          }
        }

        // --- Carica orario ---
        async function loadOrario() {
          const text = await fetch(orarioFile).then((r) => r.text());
          const lines = text.trim().split("\n");
          const headers = lines[0].split(",").map((h) => h.trim());
          scheduleData = lines.slice(1).map((line) => {
            const values = line.split(",");
            return headers.reduce((obj, header, i) => {
              obj[header] = values[i]
                ? values[i].trim().replace(/^"|"$/g, "")
                : "";
              return obj;
            }, {});
          });
        }

        // --- Parsing righe (salta header) ---
        function parseCSVText(text) {
          return text
            .trim()
            .split("\n")
            .slice(1)
            .map((r) => r.replace("\r", "").trim())
            .filter(Boolean);
        }

        // --- Normalizza stringhe (giorni con accenti, ecc.) ---
        const normalizzaGiorno = (g) =>
          (g || "")
            .toString()
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

        // --- Compresenza (no global) ---
        function isCompresenza(
          classe,
          oraInizio,
          oraFine,
          docente,
          giornoEsteso,
          assenzeGiornaliere = [],
          assenzeOrarie = []
        ) {
          if (!Array.isArray(scheduleData)) return false;

          const compresenti = scheduleData.filter(
            (r) =>
              normalizzaGiorno(r.Giorno || "") ===
                normalizzaGiorno(giornoEsteso) &&
              r.Classe?.trim() === classe?.trim() &&
              r.OraInizio === oraInizio &&
              r.OraFine === oraFine &&
              r.Docente?.trim() !== docente?.trim()
          );

          if (compresenti.length === 0) return false;

          const assG = Array.isArray(assenzeGiornaliere)
            ? assenzeGiornaliere
            : [];
          const assO = Array.isArray(assenzeOrarie) ? assenzeOrarie : [];

          const tuttiAssenti = compresenti.every((c) => {
            const nome = c.Docente?.trim() || "";
            return (
              assG.some((a) => a.nome === nome) ||
              assO.some(
                (a) => a.nome === nome && a.ora === `${oraInizio}-${oraFine}`
              )
            );
          });

          return !tuttiAssenti;
        }

        // --- Mostra risultati ---
        function displayTables(
          assenzeGiornaliere,
          assenzeOrarie,
          selectedDate,
          giornoEsteso
        ) {
          const dateObj = new Date(selectedDate);
          const giorno = String(dateObj.getDate()).padStart(2, "0");
          const mese = String(dateObj.getMonth() + 1).padStart(2, "0");
          const anno = dateObj.getFullYear();

          // ðŸ”¹ Docenti POT del giorno (escludendo COLLETTA O.)
          const potSlots = scheduleData.filter((r) => {
            const giornoRow = (r.Giorno || "").toString();
            const classeRow = (r.Classe || "").toString();
            return (
              normalizzaGiorno(giornoRow) === normalizzaGiorno(giornoEsteso) &&
              classeRow.toLowerCase() === "pot" &&
              (r.Docente || "").trim().toUpperCase() !== "COLLETTA O."
            );
          });

          // ðŸŸ© Contenitore per le righe del riepilogo
          const summaryRows = [];

          let html = `
  <div class="card mb-4">
    <div class="card-header bg-primary text-white fw-bold">
      Assenze giornaliere â€” ${giorno}/${mese}/${anno}
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead class="bg-primary text-white">
            <tr>
              <th style="width:25%;">Docente</th>
              <th style="width:35%;">Orari / Classi</th>
              <th style="width:40%;">Sostituti (POT)</th>
            </tr>
          </thead>
          <tbody>`;
          assenzeGiornaliere.forEach((a) => {
            const docente = a.nome;
            a.dettagli.forEach((det) => {
              const comp = isCompresenza(
                det.Classe,
                det.OraInizio,
                det.OraFine,
                docente,
                giornoEsteso,
                assenzeGiornaliere,
                assenzeOrarie
              );
              let potHTML = "";

              if (comp) {
                potHTML = `<em class="text-secondary">In compresenza</em>`;
                summaryRows.push({
                  docente,
                  classe: det.Classe,
                  ora: `${det.OraInizio}-${det.OraFine}`,
                  sostituto: "In compresenza",
                });
              } else {
                const potDisponibili = potSlots.filter(
                  (p) =>
                    p.OraInizio === det.OraInizio &&
                    p.OraFine === det.OraFine &&
                    p.Docente.trim().toUpperCase() !== "COLLETTA O."
                );
                potHTML =
                  potDisponibili.length > 0
                    ? potDisponibili
                        .map(
                          (p) => `
              <div class="form-check form-check-inline sub-option"
                   data-sub="${p.Docente}" data-hour="${det.OraInizio}-${
                            det.OraFine
                          }">
                <input class="form-check-input sub-check" type="radio"
                       name="sub-${docente}-${det.OraInizio.replace(
                            /\s|:/g,
                            ""
                          )}"
                       value="${p.Docente}" data-absent="${docente}"
                       data-hour="${det.OraInizio}-${
                            det.OraFine
                          }" data-class="${det.Classe}">
                <label class="form-check-label">${p.Docente}</label>
              </div>`
                        )
                        .join("")
                    : `<span class="text-muted fst-italic">Nessun POT disponibile</span>`;
              }

              html += `
      <tr>
        <td><i class="bi bi-person-fill text-primary me-1"></i>${docente}</td>
        <td>${det.OraInizio}-${det.OraFine} (${det.Classe})</td>
        <td>${potHTML}</td>
      </tr>`;
            });
          });
          html += `</tbody></table></div></div></div>`;

          // --- Assenze orarie ---
          html += `
  <div class="card mb-4">
    <div class="card-header bg-primary text-white fw-bold">
      Assenze orarie â€” ${giorno}/${mese}/${anno}
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead class="bg-primary text-white">
            <tr><th style="width:25%;">Docente</th><th>Orari / Classi / Sostituti (POT)</th></tr>
          </thead>
          <tbody>`;

          assenzeOrarie.forEach((a) => {
            const docente = a.nome;
            const oreArray = (a.ora || "")
              .split(",")
              .map((o) => o.replace(/"/g, "").trim())
              .filter(Boolean);

            let oreHTML = "";
            oreArray.forEach((oraSingola) => {
              const [oraInizio, oraFine] = oraSingola.split("-");
              const lezioni = scheduleData.filter(
                (r) =>
                  normalizzaGiorno(r.Giorno) ===
                    normalizzaGiorno(giornoEsteso) &&
                  r.Docente.trim() === docente &&
                  r.OraInizio === (oraInizio || "").trim() &&
                  r.OraFine === (oraFine || "").trim()
              );

              if (lezioni.length === 0) {
                oreHTML += `<div class="border-bottom py-1">${oraSingola} (-)<br><em class="text-muted">Nessun POT disponibile</em></div>`;
                return;
              }

              lezioni.forEach((lez) => {
                const comp = isCompresenza(
                  lez.Classe,
                  (oraInizio || "").trim(),
                  (oraFine || "").trim(),
                  docente,
                  giornoEsteso,
                  assenzeGiornaliere,
                  assenzeOrarie
                );

                let potHTML = "";
                if (comp) {
                  potHTML = `<em class="text-secondary">In compresenza</em>`;
                  // Aggiungi subito nel riepilogo
                  summaryRows.push({
                    docente,
                    classe: lez.Classe,
                    ora: oraSingola,
                    sostituto: "In compresenza",
                  });
                } else {
                  const potDisponibili = potSlots.filter(
                    (p) =>
                      p.OraInizio === (oraInizio || "").trim() &&
                      p.OraFine === (oraFine || "").trim()
                  );
                  potHTML =
                    potDisponibili.length > 0
                      ? potDisponibili
                          .map(
                            (p) => `
              <div class="form-check form-check-inline sub-option"
                   data-sub="${p.Docente}" data-hour="${oraSingola}">
                <input class="form-check-input sub-check" type="radio"
                       name="sub-${docente}-${oraSingola.replace(/\s|:/g, "")}"
                       value="${p.Docente}" data-absent="${docente}"
                       data-hour="${oraSingola}" data-class="${lez.Classe}">
                <label class="form-check-label">${p.Docente}</label>
              </div>`
                          )
                          .join("")
                      : `<span class="text-muted fst-italic">Nessun POT disponibile</span>`;
                }

                oreHTML += `<div class="border-bottom py-1"><strong>${oraSingola}</strong> (${lez.Classe})<br>${potHTML}</div>`;
              });
            });

            html += `<tr><td><i class="bi bi-person-fill text-primary me-1"></i>${docente}</td><td>${oreHTML}</td></tr>`;
          });

          html += `</tbody></table></div></div></div>`;

          // Ordina il riepilogo per ora
          summaryRows.sort((a, b) => {
            const oraA = a.ora.split("-")[0].trim();
            const oraB = b.ora.split("-")[0].trim();
            return oraA.localeCompare(oraB);
          });

          // --- Riepilogo finale ---
          html += `
  <div class="card mb-4">
    <div class="card-header bg-success text-white fw-bold">
      Riepilogo Sostituzioni Selezionate
    </div>
    <div class="card-body p-3">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="summary-table">
          <thead class="bg-success text-white">
            <tr>
              <th>Docente Assente</th>
              <th>Classe</th>
              <th>Orario</th>
              <th>Sostituto</th>
            </tr>
          </thead>
          <tbody>
            ${
              summaryRows.length > 0
                ? summaryRows
                    .map(
                      (r) => `
                <tr>
                  <td>${r.docente}</td>
                  <td>${r.classe}</td>
                  <td>${r.ora}</td>
                  <td><em>${r.sostituto}</em></td>
                </tr>`
                    )
                    .join("")
                : `<tr><td colspan="4" class="text-center text-muted">Nessuna selezione effettuata.</td></tr>`
            }
          </tbody>
        </table>
      </div>
      <div class="mt-3">
        <label for="notes" class="form-label fw-semibold">Note (opzionali)</label>
        <textarea id="notes" class="form-control" rows="3" placeholder="Scrivi eventuali note..."></textarea>
      </div>
      <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
        <button id="export-pdf-btn" class="btn btn-success px-4">
          <i class="bi bi-file-earmark-pdf"></i> Genera PDF
        </button>
        <button id="reset-sost-btn" class="btn btn-outline-danger px-4">
          <i class="bi bi-arrow-counterclockwise"></i> Resetta selezioni
        </button>
      </div>
    </div>
  </div>`;

          resultsContainer.innerHTML = html;

          document.querySelectorAll(".sub-check").forEach((radio) => {
            radio.addEventListener("change", (e) => {
              const { value: sostituto, dataset } = e.target;
              const { absent, hour, class: classe } = dataset;

              const summaryBody = document.querySelector(
                "#summary-table tbody"
              );
              if (!summaryBody) return;

              // rimuovi placeholder
              const placeholder = summaryBody.querySelector("td[colspan='4']");
              if (placeholder) placeholder.parentElement.remove();

              // aggiorna o aggiunge riga
              let existingRow = Array.from(summaryBody.rows).find(
                (r) =>
                  r.cells[0].textContent === absent &&
                  r.cells[2].textContent === hour
              );

              if (existingRow) {
                existingRow.cells[3].textContent = sostituto;
              } else {
                const newRow = summaryBody.insertRow();
                newRow.innerHTML = `
          <td>${absent}</td>
          <td>${classe}</td>
          <td>${hour}</td>
          <td>${sostituto}</td>`;
              }

              // ðŸ”¹ Nascondi il sostituto selezionato solo per altri docenti nella stessa ora
              document
                .querySelectorAll(`.sub-option[data-hour='${hour}']`)
                .forEach((opt) => {
                  const input = opt.querySelector("input");
                  const sameAbsent = input.dataset.absent === absent;
                  const sameSostituto = input.value === sostituto;

                  if (!sameAbsent && sameSostituto) {
                    opt.style.display = "none";
                  } else if (!sameAbsent && !sameSostituto) {
                    opt.style.display = "inline-block";
                  }
                });
            });
          });

          // --- ðŸŸ© Riaggancio dei pulsanti dopo il rendering ---

          // RESET
          document
            .getElementById("reset-sost-btn")
            ?.addEventListener("click", () => {
              // Deseleziona tutti i radio
              document
                .querySelectorAll(".sub-check")
                .forEach((cb) => (cb.checked = false));
              document
                .querySelectorAll(".sub-option")
                .forEach((opt) => (opt.style.display = "inline-block"));

              // Rimuove solo righe non "In compresenza"
              const summaryBody = document.querySelector(
                "#summary-table tbody"
              );
              if (summaryBody) {
                summaryBody.querySelectorAll("tr").forEach((row) => {
                  const lastCellText = (row.lastElementChild?.textContent || "")
                    .trim()
                    .toLowerCase();
                  if (!lastCellText.includes("in compresenza")) {
                    row.remove();
                  }
                });
              }

              // Messaggio di conferma
              const alertDiv = document.createElement("div");
              alertDiv.className =
                "alert alert-success text-center mt-3 fade show shadow";
              alertDiv.style.position = "fixed";
              alertDiv.style.bottom = "20px";
              alertDiv.style.left = "50%";
              alertDiv.style.transform = "translateX(-50%)";
              alertDiv.style.zIndex = "9999";
              alertDiv.style.minWidth = "280px";
              alertDiv.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i> Sostituzioni resettate con successo`;
              document.body.appendChild(alertDiv);

              setTimeout(() => {
                alertDiv.classList.remove("show");
                alertDiv.classList.add("fade");
                setTimeout(() => alertDiv.remove(), 400);
              }, 3000);

              window.scrollTo({ top: 0, behavior: "smooth" });
            });

          // EXPORT PDF
          // EXPORT PDF
          document
            .getElementById("export-pdf-btn")
            ?.addEventListener("click", () => {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({ orientation: "landscape" });

              const dateEl = document.getElementById("date-input");
              const dateObj =
                dateEl && dateEl.value ? new Date(dateEl.value) : new Date();
              const dataFmt = dateObj.toLocaleDateString("it-IT", {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              });

              doc.setFontSize(14);
              doc.text(`Sostituzioni del giorno ${dataFmt}`, 14, 15);

              // Disegna tabella
              doc.autoTable({
                html: "#summary-table",
                startY: 25,
                theme: "grid",
                headStyles: {
                  fillColor: [25, 135, 84],
                  textColor: [255, 255, 255],
                },
                styles: {
                  fontSize: 10,
                  cellPadding: 3,
                  lineColor: [222, 226, 230],
                  lineWidth: 0.2,
                  textColor: [33, 37, 41],
                },
                didParseCell: (data) => {
                  const txt =
                    data.cell.text && data.cell.text[0]
                      ? data.cell.text[0].toLowerCase()
                      : "";
                  if (txt.includes("in compresenza")) {
                    data.cell.styles.fontStyle = "italic";
                    data.cell.styles.textColor = [108, 117, 125];
                  }
                },
                margin: { top: 25, left: 10, right: 10 },
              });

              // Note (se presenti)
              const notesEl = document.getElementById("notes");
              const notesText = notesEl ? notesEl.value.trim() : "";
              if (notesText) {
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y =
                  (doc.lastAutoTable && doc.lastAutoTable.finalY
                    ? doc.lastAutoTable.finalY
                    : 25) + 10;
                if (y > pageHeight - 20) {
                  doc.addPage();
                  y = 20;
                }
                doc.setFontSize(9);
                doc.setTextColor(90);
                const wrapped = doc.splitTextToSize(notesText, pageWidth - 28);
                doc.text(wrapped, 14, y);
              }

              // âœ… CORRETTA GESTIONE DELLA PAGINAZIONE
              const pageCount = doc.getNumberOfPages();
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();

              for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                const footer = `Pagina ${i} / ${pageCount}`;
                doc.setFontSize(10);
                doc.setTextColor(150);
                const textWidth = doc.getTextWidth(footer);
                const xCenter = (pageWidth - textWidth) / 2;
                doc.text(footer, xCenter, pageHeight - 10);
              }

              // Salva PDF
              const y = String(dateObj.getFullYear());
              const m = String(dateObj.getMonth() + 1).padStart(2, "0");
              const d = String(dateObj.getDate()).padStart(2, "0");
              const filename = `riepilogo_sostituzioni_${y}${m}${d}.pdf`;
              doc.save(filename);

              // Messaggio di conferma
              const alertDiv = document.createElement("div");
              alertDiv.className =
                "alert alert-primary text-center mt-3 fade show shadow";
              alertDiv.style.position = "fixed";
              alertDiv.style.bottom = "20px";
              alertDiv.style.left = "50%";
              alertDiv.style.transform = "translateX(-50%)";
              alertDiv.style.zIndex = "9999";
              alertDiv.style.minWidth = "280px";
              alertDiv.innerHTML = `<i class="bi bi-file-earmark-check-fill me-2"></i> PDF generato correttamente`;
              document.body.appendChild(alertDiv);

              setTimeout(() => {
                alertDiv.classList.remove("show");
                alertDiv.classList.add("fade");
                setTimeout(() => alertDiv.remove(), 400);
              }, 3000);
            });
        }

        // Inserisce la riga nel riepilogo in ordine orario
        function inserisciRigaOrdinata(summaryBody, newRow) {
          const cleanHour = (h) =>
            h.replace(/\s/g, "").split("-")[0].padStart(5, "0"); // es. "8:00" â†’ "08:00"

          const newHour = cleanHour(newRow.dataset.hour || "");

          const rows = Array.from(summaryBody.querySelectorAll("tr"));
          let inserted = false;

          for (const row of rows) {
            const currentHour = cleanHour(row.dataset.hour || "");
            if (newHour < currentHour) {
              summaryBody.insertBefore(newRow, row);
              inserted = true;
              break;
            }
          }

          if (!inserted) summaryBody.appendChild(newRow);
        }

        // --- Leggi dati remoti e mostra ---
        loadBtn.addEventListener("click", async () => {
          const selectedDate = dateInput.value;
          if (!selectedDate) return alert("Seleziona una data!");
          resultsContainer.innerHTML = `<div class="alert alert-warning text-center">Lettura dei dati in corso...</div>`;

          await loadOrario();

          const dateObj = new Date(selectedDate);
          const giorno = String(dateObj.getDate()).padStart(2, "0");
          const mese = String(dateObj.getMonth() + 1).padStart(2, "0");
          const anno = dateObj.getFullYear();
          const giornoSettimana = abbrevMap[dateObj.getUTCDay()];
          const giornoEsteso = giorniEstesi[dateObj.getUTCDay()];
          const meseFolder = `${mese}`;

          const urlAssenze = `${csvBase}${meseFolder}/assenze_${giornoSettimana}-${giorno}${mese}${anno}.csv`;
          const urlPermessi = `${csvBase}${meseFolder}/permessi_${giornoSettimana}-${giorno}${mese}${anno}.csv`;

          try {
            const [assenzeCSV, permessiCSV] = await Promise.all([
              fetchCSV(urlAssenze),
              fetchCSV(urlPermessi),
            ]);

            // File \"assenze\": una colonna (nomi) con header
            const assenzeLines = parseCSVText(assenzeCSV);
            const assenzeGiornaliere = assenzeLines.map((raw) => {
              const cleanName = String(raw || "")
                .replace(/^\"|\"$/g, "")
                .trim();
              // lezioni del docente (escludi POT)
              const lezioni = scheduleData.filter(
                (r) =>
                  (r.Docente || "").trim() === cleanName &&
                  normalizzaGiorno(r.Giorno) ===
                    normalizzaGiorno(giornoEsteso) &&
                  (r.Classe || "").trim() !== "POT"
              );
              const dettagli = lezioni.map((l) => ({
                OraInizio: l.OraInizio,
                OraFine: l.OraFine,
                Classe: l.Classe,
              }));
              return { nome: cleanName, dettagli };
            });

            // File \"permessi\": formato \"NOME\",\"HH:MM-HH:MM, HH:MM-HH:MM\"
            const permLines = parseCSVText(permessiCSV);
            const assenzeOrarie = permLines
              .map((line) => {
                const clean = String(line || "")
                  .trim()
                  .replace(/\r/g, "");
                const m = clean.match(/^\"?(.*?)\"?\s*,\s*\"?(.+?)\"?$/);
                if (!m) return null;
                const docente = m[1].trim().replace(/^\"|\"$/g, "");
                const oreRaw = m[2].trim();
                const oreArray = oreRaw
                  .split(",")
                  .map((o) => o.replace(/\"/g, "").trim())
                  .filter(Boolean);
                return { nome: docente, ora: oreArray.join(", ") };
              })
              .filter(Boolean);

            displayTables(
              assenzeGiornaliere,
              assenzeOrarie,
              selectedDate,
              giornoEsteso
            );
          } catch (error) {
            console.error(error);
            resultsContainer.innerHTML = `
    <div class="alert alert-danger text-center">
      Errore nella lettura dei file CSV: ${error.message}
    </div>`;
          }
        });
      });
    </script>
  </body>
</html>
