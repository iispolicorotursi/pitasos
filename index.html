<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PitaSOS â€“ Gestione Sostituzioni</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  </head>

  <body class="bg-light">
    <div class="container my-4" id="main-container">
      <h1 class="text-center mb-4 text-primary fw-bold">PitaSOS</h1>

      <!-- ðŸ”¹ Sezione Data -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white fw-bold">
          1. Seleziona la data
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center">
            <label for="date-input" class="form-label me-2 mb-0">Data:</label>
            <input
              type="date"
              id="date-input"
              class="form-control w-auto me-2"
            />
            <!-- Il pulsante Leggi dati sarÃ  aggiunto via JS -->
          </div>
        </div>
      </div>

      <!-- ðŸ”¹ Contenitore risultati -->
      <div id="results-container">
        <div class="alert alert-info text-center mb-0">
          I dati letti dai file CSV verranno mostrati qui.
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.getElementById("date-input");
        const resultsContainer = document.getElementById("results-container");

        // Imposta la data odierna di default
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        dateInput.value = `${year}-${month}-${day}`;

        // ðŸ”¹ Crea pulsante "Leggi dati"
        const readDataBtn = document.createElement("button");
        readDataBtn.className = "btn btn-outline-primary ms-2";
        readDataBtn.innerHTML =
          '<i class="bi bi-cloud-download"></i> Leggi dati';
        dateInput.parentNode.appendChild(readDataBtn);

        // ðŸ”¹ Funzione per ottenere abbreviazione del giorno (lun, mar, mer, ecc.)
        function getDayAbbr(dateObj) {
          const days = ["dom", "lun", "mar", "mer", "gio", "ven", "sab"];
          return days[dateObj.getDay()];
        }

        // ðŸ”¹ Funzione principale: lettura file CSV remoti
        readDataBtn.addEventListener("click", async () => {
          const selectedDate = dateInput.value;
          if (!selectedDate) {
            alert("Seleziona una data prima di leggere i dati.");
            return;
          }

          const dateObj = new Date(selectedDate);
          const dayAbbr = getDayAbbr(dateObj);
          const day = String(dateObj.getDate()).padStart(2, "0");
          const month = String(dateObj.getMonth() + 1).padStart(2, "0");
          const year = dateObj.getFullYear();

          const baseUrl = `https://progetti.antoniofittipaldi.it/pitasos/${month}`;
          const assenzeUrl = `${baseUrl}/assenze_${dayAbbr}${day}${month}${year}.csv`;
          const permessiUrl = `${baseUrl}/permessi_${dayAbbr}${day}${month}${year}.csv`;

          resultsContainer.innerHTML = `
            <div class="alert alert-info text-center">Lettura dati da remoto in corso...</div>
          `;

          try {
            const [assenzeRes, permessiRes] = await Promise.all([
              fetch(assenzeUrl),
              fetch(permessiUrl),
            ]);

            const assenzeText = assenzeRes.ok ? await assenzeRes.text() : null;
            const permessiText = permessiRes.ok
              ? await permessiRes.text()
              : null;

            // ðŸ”¹ Parsing CSV semplici
            const parseCSV = (text) =>
              text
                ? text
                    .trim()
                    .split("\n")
                    .slice(1)
                    .map((line) => line.split(",")[0].trim())
                    .filter(Boolean)
                : [];

            const assenti = parseCSV(assenzeText);
            const permessi = permessiText
              ? permessiText
                  .trim()
                  .split("\n")
                  .slice(1)
                  .map((line) => {
                    const [doc, start, end] = line.split(",");
                    return {
                      docente: doc.trim(),
                      inizio: start?.trim(),
                      fine: end?.trim(),
                    };
                  })
              : [];

            // ðŸ”¹ Mostra risultati
            resultsContainer.innerHTML = `
              <div class="card mb-3">
                <div class="card-header bg-primary text-white fw-bold">
                  Dati per ${selectedDate} (${dayAbbr.toUpperCase()})
                </div>
                <div class="card-body">
                  ${
                    assenti.length > 0
                      ? `<h6 class="fw-bold">Assenti giornalieri:</h6>
                         <ul>${assenti
                           .map((a) => `<li>${a}</li>`)
                           .join("")}</ul>`
                      : `<p class="text-muted fst-italic">Nessun assente giornaliero.</p>`
                  }

                  ${
                    permessi.length > 0
                      ? `<h6 class="fw-bold mt-3">Permessi orari:</h6>
                         <ul>${permessi
                           .map(
                             (p) =>
                               `<li>${p.docente} â€” ${p.inizio || "?"} - ${
                                 p.fine || "?"
                               }</li>`
                           )
                           .join("")}</ul>`
                      : `<p class="text-muted fst-italic">Nessun permesso orario.</p>`
                  }
                </div>
              </div>
            `;
          } catch (error) {
            console.error(error);
            resultsContainer.innerHTML = `
              <div class="alert alert-danger text-center">
                Errore durante la lettura dei file CSV: ${error.message}
              </div>
            `;
          }
        });
      });
    </script>
  </body>
</html>
