<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PitaSOS</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
      body {
        font-family: "Nunito", sans-serif;
        background-color: #f8f9fa;
        padding: 1rem;
      }
      .main-container {
        max-width: 1100px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        font-weight: 700;
        color: #0d6efd;
        margin-bottom: 1.5rem;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .table th,
      .table td {
        vertical-align: middle !important;
      }
      .table thead th {
        white-space: nowrap;
      }
      .teacher-cell {
        width: 220px;
      }
      .hour-col {
        width: 120px;
        text-align: center;
      }
      .comp-text {
        color: #6c757d;
        font-style: italic;
        text-align: center;
      }
      .select-pot {
        min-width: 150px;
      }
      .class-label {
        font-size: 0.8em;
        font-weight: 700;
        color: #6c757d;
        display: block;
        text-align: center;
        margin-bottom: 0.25rem;
      }
      option:disabled {
        color: #999 !important;
        background-color: #f8f9fa !important;
        font-style: italic;
      }
      .comp-text {
        color: #6c757d;
        font-style: italic;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="text-center mt-4 mb-4">
        <i
          class="bi bi-person-lines-fill text-primary"
          style="font-size: 3rem"
        ></i>
        <h1 class="fw-bold mb-1 mt-2">PitaSOS</h1>
        <p class="text-muted fst-italic mb-0">
          Versione per chi si occupa delle sostituzioni
        </p>
      </div>

      <div class="card mb-3">
        <div class="card-header bg-primary text-white fw-semibold">
          1. Seleziona la data
        </div>
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row align-items-md-end gap-3">
            <div class="flex-fill">
              <label for="date-input" class="form-label fw-semibold"
                >Data:</label
              >
              <input type="date" class="form-control" id="date-input" />
            </div>
            <div>
              <button id="load-btn" class="btn btn-primary px-4">
                <i class="bi bi-download"></i> Leggi dati
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="results-container">
        <div class="alert alert-info text-center mb-0">
          I risultati verranno mostrati qui dopo la lettura dei dati.
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const HOURS = [
          "08:00-09:00",
          "09:00-10:00",
          "10:00-11:00",
          "11:00-12:00",
          "12:00-13:00",
          "13:00-14:00",
        ];

        const dateInput = document.getElementById("date-input");
        const loadBtn = document.getElementById("load-btn");
        const resultsContainer = document.getElementById("results-container");

        const remoteBaseUrl = "https://progetti.antoniofittipaldi.it/";
        const csvDataPath = "pitasos/";
        const phpScriptUrl = remoteBaseUrl + "pitasos/salva_sostituzioni.php";

        const corsProxy = "https://api.allorigins.win/raw?url=";
        const orarioFile = "orario.csv";
        const abbrevMap = ["dom", "lun", "mar", "mer", "gio", "ven", "sab"];
        const giorniEstesi = [
          "Domenica",
          "Luned√¨",
          "Marted√¨",
          "Mercoled√¨",
          "Gioved√¨",
          "Venerd√¨",
          "Sabato",
        ];

        let scheduleData = [];

        const oggi = new Date();
        dateInput.value = `${oggi.getFullYear()}-${String(
          oggi.getMonth() + 1
        ).padStart(2, "0")}-${String(oggi.getDate()).padStart(2, "0")}`;

        async function fetchCSV(url) {
          try {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return await r.text();
          } catch {
            const p = await fetch(corsProxy + encodeURIComponent(url));
            if (!p.ok) throw new Error(`Proxy ${p.status}`);
            return await p.text();
          }
        }

        async function loadOrario() {
          const text = await fetch(orarioFile).then((r) => r.text());
          const lines = text.trim().split("\n");
          const headers = lines[0].split(",").map((h) => h.trim());

          scheduleData = lines.slice(1).map((line) => {
            const values = line.split(",");
            const obj = headers.reduce((o, h, i) => {
              o[h] = values[i] ? values[i].trim().replace(/^"|"$/g, "") : "";
              return o;
            }, {});

            // üîç Riconosci lezioni POT in base al suffisso "(P)" nel nome classe
            const classeRaw = (obj.Classe || "").trim();
            if (/\(P\)\s*$/.test(classeRaw)) {
              obj.Classe = classeRaw.replace(/\(P\)\s*$/, "").trim(); // rimuove (P) per la visualizzazione
              obj.isPOT = true; // flag interno
            } else {
              obj.isPOT = false;
            }

            return obj;
          });
        }

        function parseCSVText(text) {
          return text
            .trim()
            .split("\n")
            .slice(1)
            .map((r) => r.replace("\r", "").trim())
            .filter(Boolean);
        }

        const normalizzaGiorno = (g) =>
          (g || "")
            .toString()
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

        function isPotenziamentoRow(row) {
          return /\(P\)\s*$/.test((row.Classe || "").trim());
        }

        function isDocenteAssente(
          nome,
          oraInizio,
          oraFine,
          assenzeGiornaliere,
          assenzeOrarie
        ) {
          const nomeTrim = (nome || "").trim();
          return (
            assenzeGiornaliere.some((a) => a.nome === nomeTrim) ||
            assenzeOrarie.some(
              (a) =>
                a.nome === nomeTrim && a.ora.includes(`${oraInizio}-${oraFine}`)
            )
          );
        }

        function sameClassCompresenzaAssenti(
          classe,
          oraInizio,
          oraFine,
          giornoEsteso,
          assenzeGiornaliere,
          assenzeOrarie
        ) {
          const altri = scheduleData.filter(
            (r) =>
              normalizzaGiorno(r.Giorno || "") ===
                normalizzaGiorno(giornoEsteso) &&
              r.Classe.replace(/\(P\)/g, "").trim() ===
                classe.replace(/\(P\)/g, "").trim()
          );
          if (altri.length < 2) return false;

          const tuttiAssenti = altri.every((r) =>
            isDocenteAssente(
              r.Docente,
              oraInizio,
              oraFine,
              assenzeGiornaliere,
              assenzeOrarie
            )
          );

          const almenoUnoPOT = altri.some((r) => r.isPOT);
          const almenoUnoNonPOT = altri.some((r) => !r.isPOT);

          return tuttiAssenti && almenoUnoPOT && almenoUnoNonPOT;
        }

        function isCompresenza(
          classe,
          oraInizio,
          oraFine,
          docente,
          giornoEsteso,
          assG = [],
          assO = []
        ) {
          if (!Array.isArray(scheduleData))
            return { stato: false, compresente: null };
          const compresenti = scheduleData.filter(
            (r) =>
              normalizzaGiorno(r.Giorno || "") ===
                normalizzaGiorno(giornoEsteso) &&
              (r.Classe || "").trim() === (classe || "").trim() &&
              r.OraInizio === oraInizio &&
              r.OraFine === oraFine &&
              (r.Docente || "").trim() !== (docente || "").trim()
          );
          if (!compresenti.length) return { stato: false, compresente: null };
          const presenti = compresenti.filter((c) => {
            const nome = (c.Docente || "").trim();
            const assente =
              assG.some((a) => a.nome === nome) ||
              assO.some(
                (a) =>
                  a.nome === nome && a.ora.includes(`${oraInizio}-${oraFine}`)
              );
            return !assente;
          });
          return presenti.length
            ? { stato: true, compresente: presenti[0].Docente.trim() }
            : { stato: false, compresente: null };
        }

        function updateSummaryCell(absent, hour, text, className) {
          const cell = document.querySelector(
            `#summary-grid tbody tr[data-absent="${CSS.escape(
              absent
            )}"] td[data-hour="${hour}"]`
          );
          if (!cell) return;
          if (!text) {
            if (
              !cell.dataset.comp &&
              !cell.dataset.pot &&
              !cell.dataset.permesso
            )
              cell.innerHTML = "";
            return;
          }
          if (text.toLowerCase().includes("compresenza")) {
            cell.innerHTML = `<em>${text}</em>`;
            cell.dataset.comp = "1";
          } else if (text.toUpperCase() === "POT") {
            cell.innerHTML = `<strong class="text-secondary">POT</strong>`;
            cell.dataset.pot = "1";
          } else if (text.toLowerCase().includes("permesso")) {
            cell.innerHTML = `<em class="comp-text">${text}</em>`;
            cell.dataset.permesso = "1";
          } else {
            cell.innerHTML = `${text}<br>(${className})`;
            delete cell.dataset.comp;
            delete cell.dataset.pot;
            delete cell.dataset.permesso;
          }
        }

        function refreshPotVisibilityForHour(hour) {
          // Tutti i <select> relativi a quell‚Äôora
          const selects = document.querySelectorAll(
            `select[data-hour='${hour}']`
          );

          // Raccogli i nomi dei docenti gi√† scelti (sia tramite select che input manuale)
          const selectedTeachers = new Set();

          selects.forEach((sel) => {
            if (sel.value) selectedTeachers.add(sel.value);
            const manualInput = sel.parentElement.querySelector(".manual-pot");
            if (manualInput && manualInput.value.trim()) {
              selectedTeachers.add(manualInput.value.trim());
            }
          });

          // Ora disabilitiamo dinamicamente le opzioni usate
          selects.forEach((sel) => {
            const myValue = sel.value; // il valore del menu corrente
            sel.querySelectorAll("option[data-pot]").forEach((op) => {
              // disabilita se scelto da qualcun altro, ma non se √® il mio valore attuale
              if (selectedTeachers.has(op.value) && op.value !== myValue) {
                op.disabled = true;
                op.textContent = `${op.value} (occupato)`;
              } else {
                op.disabled = false;
                op.textContent = op.value;
              }
            });
          });
        }

        function displayTables(
          assenzeGiornaliere,
          assenzeOrarie,
          selectedDate,
          giornoEsteso,
          savedChoices
        ) {
          const dateObj = new Date(selectedDate);
          const g = String(dateObj.getDate()).padStart(2, "0");
          const m = String(dateObj.getMonth() + 1).padStart(2, "0");
          const a = dateObj.getFullYear();
          const allAbsentNames = new Set([
            ...assenzeGiornaliere.map((a) => a.nome),
            ...assenzeOrarie.map((a) => a.nome),
          ]);
          // üîπ Docenti di potenziamento (da classi con "(P)" nel CSV)
          const potSlots = scheduleData.filter(
            (r) =>
              normalizzaGiorno(r.Giorno || "") ===
                normalizzaGiorno(giornoEsteso) &&
              r.isPOT === true &&
              (r.Docente || "").trim().toUpperCase() !== "COLLETTA O." &&
              (r.Docente || "").trim().toUpperCase() !== "RINA T." &&
              (r.Docente || "").trim().toUpperCase() !== "BATTIFARANO C." &&
              (r.Docente || "").trim().toUpperCase() !== "BRUNO E."
          );

          const potForHour = (hour, absentTeachersSet) => {
            const [oi, of] = hour.split("-");

            // tutti i docenti che hanno POT in questa ora
            const availableTeachers = potSlots
              .filter((p) => p.OraInizio === oi && p.OraFine === of)
              .map((p) => p.Docente.trim());

            // Filtriamo i docenti effettivamente indisponibili in questa specifica ora
            return availableTeachers.filter((teacher) => {
              // se assente per l'intera giornata ‚Üí non disponibile
              if (assenzeGiornaliere.some((a) => a.nome === teacher))
                return false;

              // se assente orario in questa ora specifica ‚Üí non disponibile
              if (
                assenzeOrarie.some(
                  (a) =>
                    a.nome === teacher &&
                    a.ora
                      .split(",")
                      .map((h) => h.trim())
                      .includes(hour)
                )
              )
                return false;

              // altrimenti disponibile
              return true;
            });
          };

          let html = `<div class="card mb-4"><div class="card-header bg-primary text-white fw-bold">Assenze giornaliere ‚Äî ${g}/${m}/${a}</div><div class="table-responsive"><table class="table table-striped table-hover mb-0 align-middle"><thead class="bg-primary text-white"><tr><th class="teacher-cell">Docente assente</th>${HOURS.map(
            (h) => `<th class="hour-col">${h}</th>`
          ).join("")}</tr></thead><tbody>`;
          const compRows = [];
          const potRows = [];

          assenzeGiornaliere.forEach((ag) => {
            const docente = ag.nome;
            const byHour = {};
            ag.dettagli.forEach((d) => {
              byHour[`${d.OraInizio}-${d.OraFine}`] = {
                classe: d.Classe,
                Oi: d.OraInizio,
                Of: d.OraFine,
              };
            });
            html += `<tr><td><i class="bi bi-person-fill text-primary me-1"></i>${docente}</td>`;
            HOURS.forEach((hour) => {
              if (byHour[hour]) {
                const { classe, Oi, Of } = byHour[hour];

                // üîç 1Ô∏è‚É£ Verifica se il docente √® di potenziamento (P)
                const docenteRow = scheduleData.find(
                  (r) =>
                    normalizzaGiorno(r.Giorno || "") ===
                      normalizzaGiorno(giornoEsteso) &&
                    (r.Docente || "").trim() === docente &&
                    r.OraInizio === Oi &&
                    r.OraFine === Of
                );

                if (docenteRow && docenteRow.isPOT) {
                  // üîé Controlla se nella stessa ora/classe c'√® un curricolare
                  const curricolariPresenti = scheduleData.filter(
                    (r) =>
                      normalizzaGiorno(r.Giorno || "") ===
                        normalizzaGiorno(giornoEsteso) &&
                      r.OraInizio === Oi &&
                      r.OraFine === Of &&
                      r.Docente.trim() !== docente.trim() &&
                      !r.isPOT &&
                      r.Classe.replace(/\(P\)/g, "").trim() ===
                        classe.replace(/\(P\)/g, "").trim()
                  );

                  if (curricolariPresenti.length > 0) {
                    // üîπ Se esiste almeno un curricolare, non sostituire il docente di potenziamento
                    html += `<td class="text-center">
                  <div class="class-label">${classe}</div>
                  <div class="comp-text">In compresenza</div>
                </td>`;
                    compRows.push({
                      docente,
                      ora: hour,
                      text: "In compresenza",
                    });
                    return; // passa alla prossima ora
                  }
                }

                // üîç 2Ô∏è‚É£ Se non √® potenziamento, procedi con la normale logica di compresenza o sostituzione
                const comp = isCompresenza(
                  classe,
                  Oi,
                  Of,
                  docente,
                  giornoEsteso,
                  assenzeGiornaliere,
                  assenzeOrarie
                );

                if (comp.stato) {
                  const label = `In compresenza${
                    comp.compresente ? `<br>(${comp.compresente})` : ""
                  }`;
                  html += `<td class="text-center">
                <div class="class-label">${classe}</div>
                <div class="comp-text">${label}</div>
              </td>`;
                  compRows.push({ docente, ora: hour, text: label });
                } else {
                  // üîπ Elenco docenti POT disponibili per quell'ora
                  const list = potForHour(hour, allAbsentNames);
                  const choiceKey = `${docente}|${hour}`;
                  const savedChoice = savedChoices.get(choiceKey);
                  let selectValue = "",
                    inputValue = "",
                    selectDisabled = false;

                  if (savedChoice && savedChoice.Tipo === "SOSTITUZIONE") {
                    if (list.includes(savedChoice.Sostituto)) {
                      selectValue = savedChoice.Sostituto;
                    } else {
                      inputValue = savedChoice.Sostituto;
                      selectDisabled = true;
                    }
                  }

                  // üîπ Se ci sono POT disponibili ‚Üí menu a tendina
                  if (list.length > 0) {
                    html += `<td class="text-center">
                  <div class="class-label">${classe}</div>
                  <select class="form-select form-select-sm select-pot"
                          data-absent="${docente}"
                          data-hour="${hour}"
                          data-class="${classe}"
                          ${selectDisabled ? "disabled" : ""}>
                    <option value="">‚Äî</option>
                    ${list
                      .map(
                        (n) =>
                          `<option data-pot value="${n}" ${
                            n === selectValue ? "selected" : ""
                          }>${n}</option>`
                      )
                      .join("")}
                  </select>
                  <input type="text"
                         class="form-control form-control-sm mt-1 manual-pot"
                         placeholder="Manuale..."
                         value="${inputValue}"
                         data-absent="${docente}"
                         data-hour="${hour}"
                         data-class="${classe}">
                </td>`;
                  } else {
                    // üîπ Nessun POT disponibile ‚Üí campo manuale (non scritta "Nessun POT")
                    html += `<td class="text-center">
                  <div class="class-label">${classe}</div>
                  <input type="text"
                         class="form-control form-control-sm manual-pot"
                         placeholder="Manuale..."
                         data-absent="${docente}"
                         data-hour="${hour}"
                         data-class="${classe}">
                </td>`;
                  }
                }
              } else {
                html += `<td></td>`;
              }
            });
            html += `</tr>`;
          });
          html += `</tbody></table></div></div>`;

          html += `<div class="card mb-4"><div class="card-header bg-primary text-white fw-bold">Assenze orarie ‚Äî ${g}/${m}/${a}</div><div class="table-responsive"><table class="table table-striped table-hover mb-0 align-middle"><thead class="bg-primary text-white"><tr><th class="teacher-cell">Docente assente</th>${HOURS.map(
            (h) => `<th class="hour-col">${h}</th>`
          ).join("")}</tr></thead><tbody>`;
          const permessoRows = [];
          if (!assenzeOrarie.length) {
            html += `<tr><td colspan="${
              1 + HOURS.length
            }" class="text-center text-muted py-3 fst-italic">Nessuna assenza oraria per la data selezionata</td></tr>`;
          } else {
            assenzeOrarie.forEach((aor) => {
              const docente = aor.nome;
              const oreArray = String(aor.ora || "")
                .split(",")
                .map((o) => o.trim())
                .filter(Boolean);
              html += `<tr><td><i class="bi bi-person-fill text-primary me-1"></i>${docente}</td>`;
              HOURS.forEach((hour) => {
                // ======================= INIZIO MODIFICA =======================
                if (oreArray.includes(hour)) {
                  // Cerca l'attivit√† del docente in quell'ora
                  const [oi, of] = hour.split("-");
                  const lez = scheduleData.find(
                    (r) =>
                      normalizzaGiorno(r.Giorno) ===
                        normalizzaGiorno(giornoEsteso) &&
                      (r.Docente || "").trim() === docente &&
                      r.OraInizio === oi &&
                      r.OraFine === of
                  );
                  const classe = lez ? lez.Classe : "-";

                  if ((classe || "").trim().toUpperCase() === "POT") {
                    // Mostra "Permesso orario" con lo stesso stile di "In compresenza"
                    html += `<td class="text-center"><div class="class-label">${classe}</div><div class="text-center">Permesso orario</div></td>`;
                    permessoRows.push({
                      docente,
                      ora: hour,
                      text: "Permesso orario",
                    });
                  } else {
                    // Se era in classe, mostra le opzioni di sostituzione
                    const comp = isCompresenza(
                      classe,
                      oi,
                      of,
                      docente,
                      giornoEsteso,
                      assenzeGiornaliere,
                      assenzeOrarie
                    );
                    if (comp.stato) {
                      const label = `In compresenza${
                        comp.compresente ? `<br>(${comp.compresente})` : ""
                      }`;
                      html += `<td class="text-center"><div class="class-label">${classe}</div><div class="comp-text">${label}</div></td>`;
                      compRows.push({ docente, ora: hour, text: label });
                    } else {
                      const list = potForHour(hour, allAbsentNames);
                      const choiceKey = `${docente}|${hour}`;
                      const savedChoice = savedChoices.get(choiceKey);
                      let selectValue = "",
                        inputValue = "",
                        selectDisabled = false;
                      if (savedChoice && savedChoice.Tipo === "SOSTITUZIONE") {
                        if (list.includes(savedChoice.Sostituto)) {
                          selectValue = savedChoice.Sostituto;
                        } else {
                          inputValue = savedChoice.Sostituto;
                          selectDisabled = true;
                        }
                      }
                      html += `<td class="text-center"><div class="class-label">${classe}</div><select class="form-select form-select-sm select-pot" data-absent="${docente}" data-hour="${hour}" data-class="${classe}" ${
                        selectDisabled ? "disabled" : ""
                      }><option value="">‚Äî</option>${list
                        .map(
                          (n) =>
                            `<option data-pot value="${n}" ${
                              n === selectValue ? "selected" : ""
                            }>${n}</option>`
                        )
                        .join(
                          ""
                        )}</select><input type="text" class="form-control form-control-sm mt-1 manual-pot" placeholder="Manuale..." value="${inputValue}" data-absent="${docente}" data-hour="${hour}" data-class="${classe}"></td>`;
                    }
                  }
                } else {
                  html += `<td></td>`;
                }
                // ======================== FINE MODIFICA ========================
              });
              html += `</tr>`;
            });
          }
          html += `</tbody></table></div></div>`;

          const allAbsentForSummary = Array.from(
            new Set([
              ...assenzeGiornaliere.map((x) => x.nome),
              ...assenzeOrarie.map((x) => x.nome),
            ])
          ).sort((a, b) => a.localeCompare(b));
          html += `<div class="card mb-4"><div class="card-header bg-success text-white fw-bold">Riepilogo Sostituzioni Selezionate</div><div class="card-body p-3"><div class="table-responsive"><table class="table table-striped table-hover align-middle" id="summary-grid"><thead class="bg-success text-white"><tr><th class="teacher-cell">Docente assente</th>${HOURS.map(
            (h) => `<th class="hour-col">${h}</th>`
          ).join("")}</tr></thead><tbody>${allAbsentForSummary
            .map(
              (nome) =>
                `<tr data-absent="${nome}"><td>${nome}</td>${HOURS.map(
                  (h) => `<td data-hour="${h}" class="text-center"></td>`
                ).join("")}</tr>`
            )
            .join(
              ""
            )}</tbody></table></div><div class="mt-3"><label for="notes" class="form-label fw-semibold">Note (opzionali)</label><textarea id="notes" class="form-control" rows="3" placeholder="Scrivi eventuali note..."></textarea></div><div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4"><button id="export-pdf-btn" class="btn btn-outline-success px-4 fw-semibold"><i class="bi bi-file-earmark-pdf-fill me-1"></i> Scarica PDF e Salva Riepilogo</button><button id="reset-sost-btn" class="btn btn-outline-danger px-4 fw-semibold"><i class="bi bi-arrow-counterclockwise me-1"></i> Resetta selezioni</button></div></div></div>`;

          resultsContainer.innerHTML = html;
          compRows.forEach((row) =>
            updateSummaryCell(row.docente, row.ora, row.text)
          );
          potRows.forEach((row) =>
            updateSummaryCell(row.docente, row.ora, "POT", "POT")
          );
          permessoRows.forEach((row) =>
            updateSummaryCell(row.docente, row.ora, row.text)
          );

          if (savedChoices && savedChoices.size > 0) {
            // Aspetta che tutto il DOM (tabelle e select) sia davvero pronto
            const ripristina = () => {
              console.groupCollapsed("üîÅ Ripristino sostituzioni salvate");

              savedChoices.forEach((choice, key) => {
                const [absentRaw, hourRaw] = key.split("|");
                const {
                  Sostituto,
                  Classe,
                  Tipo,
                  Origine = "SELECT",
                  Disabled = false,
                } = choice;

                // Trova i controlli corrispondenti nell‚Äôinterfaccia
                const select = document.querySelector(
                  `select[data-absent="${CSS.escape(
                    absentRaw
                  )}"][data-hour="${hourRaw}"]`
                );
                const input = document.querySelector(
                  `input[data-absent="${CSS.escape(
                    absentRaw
                  )}"][data-hour="${hourRaw}"]`
                );

                // Ripristina SOSTITUZIONI manuali o da menu
                if (Tipo === "SOSTITUZIONE" && Sostituto) {
                  if (Origine === "SELECT" && select) {
                    select.value = Sostituto;
                    if (input) input.value = "";
                  } else if (Origine === "MANUAL" && input) {
                    input.value = Sostituto;
                    if (Disabled && select) select.disabled = true;
                  }

                  // ‚úÖ Aggiorna la tabella riepilogo
                  updateSummaryCell(absentRaw, hourRaw, Sostituto, Classe);
                }

                // ‚úÖ Gestione altre tipologie
                if (Tipo === "COMPRESENZA") {
                  const compName =
                    Sostituto && !/in compresenza/i.test(Sostituto)
                      ? ` (${Sostituto})`
                      : "";
                  const text = `In compresenza${compName}`;
                  updateSummaryCell(absentRaw, hourRaw, text, Classe);
                }
                if (Tipo === "PERMESSO_ORARIO") {
                  updateSummaryCell(absentRaw, hourRaw, "Permesso orario", "");
                }
                if (Tipo === "POTENZIAMENTO") {
                  updateSummaryCell(absentRaw, hourRaw, "POT", "POT");
                }
              });

              console.groupEnd();
              HOURS.forEach(refreshPotVisibilityForHour);

              // Messaggio visivo di conferma
              const alert = document.createElement("div");
              alert.className =
                "alert alert-primary text-center mt-3 fade show shadow";
              alert.style.position = "fixed";
              alert.style.bottom = "20px";
              alert.style.left = "50%";
              alert.style.transform = "translateX(-50%)";
              alert.style.zIndex = "9999";
              alert.style.minWidth = "300px";
              alert.innerHTML = `<i class="bi bi-arrow-clockwise me-2"></i> Riepilogo precedente ripristinato`;
              document.body.appendChild(alert);
              setTimeout(() => {
                alert.classList.remove("show");
                alert.classList.add("fade");
                setTimeout(() => alert.remove(), 400);
              }, 3000);
            };

            // Attendi fino a che tutte le select non sono nel DOM
            const interval = setInterval(() => {
              const total = document.querySelectorAll(
                "select[data-absent]"
              ).length;
              if (total > 0) {
                clearInterval(interval);
                setTimeout(ripristina, 400); // attesa extra per sicurezza
              }
            }, 300);
          }
        }

        async function uploadCsvToServer(csvContent, filename, remotePath) {
          try {
            const formData = new FormData();
            formData.append("path", remotePath);
            formData.append("filename", filename);
            formData.append("csv_content", csvContent);

            const response = await fetch(phpScriptUrl, {
              method: "POST",
              body: formData,
            });
            const result = await response.json();

            if (response.ok && result.status === "success") {
              console.log(
                "File CSV salvato con successo sul server:",
                result.message
              );
            } else {
              console.error(
                "Errore nel salvataggio del file CSV sul server:",
                result.message
              );
              alert(
                "Attenzione: si √® verificato un errore durante il salvataggio del riepilogo sul server. Controllare la console per i dettagli."
              );
            }
          } catch (error) {
            console.error("Errore di rete o nella richiesta:", error);
            alert(
              "Attenzione: impossibile comunicare con il server per il salvataggio del riepilogo. Controllare la connessione e la configurazione."
            );
          }
        }

        document.addEventListener("click", function (e) {
          if (e.target.closest("#export-pdf-btn")) {
            const allSelects = document.querySelectorAll(
              "select.select-pot:not(:disabled)"
            );
            let allChoicesMade = true;
            if (allSelects.length > 0) {
              for (const sel of allSelects) {
                const correspondingInput =
                  sel.parentElement.querySelector(`input.manual-pot`);
                const choiceMade =
                  sel.value ||
                  (correspondingInput && correspondingInput.value.trim());
                if (!choiceMade) {
                  allChoicesMade = false;
                  break;
                }
              }
            }
            if (!allChoicesMade) {
              if (
                !confirm(
                  "Non tutte le scelte sono state effettuate: generare comunque il PDF e salvare il riepilogo?"
                )
              )
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "landscape" });
            const dateEl = document.getElementById("date-input");
            const dateObj =
              dateEl && dateEl.value ? new Date(dateEl.value) : new Date();
            const dataFmt = dateObj.toLocaleDateString("it-IT", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            doc.setFontSize(14);
            const summaryTable = document.getElementById("summary-grid");
            if (!summaryTable) {
              alert("Nessuna tabella di riepilogo disponibile per il PDF.");
              return;
            }

            doc.autoTable({
              html: "#summary-grid",
              startY: 25,
              theme: "grid",
              headStyles: {
                fillColor: [25, 135, 84],
                textColor: [255, 255, 255],
                halign: "center",
                valign: "middle",
              },
              styles: {
                fontSize: 10,
                cellPadding: 3,
                lineColor: [222, 226, 230],
                lineWidth: 0.2,
                textColor: [33, 37, 41],
                halign: "center",
                valign: "middle",
              },
              tableWidth: "auto",
              tableLineWidth: 0.1,
              didDrawPage: (data) => {
                const pageWidth = doc.internal.pageSize.getWidth();
                doc.setFontSize(14);
                doc.setTextColor(33, 37, 41);
                doc.setFont("helvetica", "bold");
                doc.text(
                  `Sostituzioni del giorno ${dataFmt}`,
                  pageWidth / 2,
                  15,
                  { align: "center" }
                );
              },
              didParseCell: (data) => {
                const txt =
                  data.cell.text && data.cell.text[0]
                    ? data.cell.text[0].toLowerCase()
                    : "";
                if (
                  data.section === "head" &&
                  data.column.index === 0 &&
                  txt.includes("docente")
                ) {
                  data.cell.text[0] = "Docente assente";
                }
                if (txt.includes("in compresenza")) {
                  data.cell.styles.fontStyle = "italic";
                  data.cell.styles.textColor = [108, 117, 125];
                }
                if (data.section === "body" && data.column.index === 0) {
                  data.cell.styles.textColor = [220, 53, 69];
                }
                if (data.cell.text[0].toUpperCase() === "POT") {
                  data.cell.styles.fontStyle = "bold";
                  data.cell.styles.textColor = [108, 117, 125];
                }
                if (txt.includes("permesso orario")) {
                  data.cell.styles.fontStyle = "italic";
                  data.cell.styles.textColor = [108, 117, 125]; // stesso grigio di "In compresenza"
                }
              },
              margin: { top: 20, left: 10, right: 10 },
            });

            const notesEl = document.getElementById("notes");
            const notesText = notesEl ? notesEl.value.trim() : "";
            if (notesText) {
              const pageWidth = doc.internal.pageSize.getWidth();
              let y =
                (doc.lastAutoTable && doc.lastAutoTable.finalY
                  ? doc.lastAutoTable.finalY
                  : 25) + 10;
              doc.setFontSize(9);
              doc.setTextColor(90);
              const wrapped = doc.splitTextToSize(notesText, pageWidth - 28);
              doc.text(wrapped, 14, y);
            }

            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();
              const footer = `Pagina ${i} / ${pageCount}`;
              doc.setFontSize(10);
              doc.setTextColor(150);
              const textWidth = doc.getTextWidth(footer);
              const xCenter = (pageWidth - textWidth) / 2;
              doc.text(footer, xCenter, pageHeight - 10);
            }

            const y_pdf = String(dateObj.getFullYear());
            const m_pdf = String(dateObj.getMonth() + 1).padStart(2, "0");
            const d_pdf = String(dateObj.getDate()).padStart(2, "0");
            const pdfFilename = `riepilogo_sostituzioni_${d_pdf}${m_pdf}${y_pdf}.pdf`;
            doc.save(pdfFilename);

            const alertDiv = document.createElement("div");
            alertDiv.className =
              "alert alert-success text-center mt-3 fade show shadow";
            alertDiv.style.position = "fixed";
            alertDiv.style.bottom = "20px";
            alertDiv.style.left = "50%";
            alertDiv.style.transform = "translateX(-50%)";
            alertDiv.style.zIndex = "9999";
            alertDiv.style.minWidth = "280px";
            alertDiv.innerHTML = `<i class="bi bi-file-earmark-pdf-fill me-2"></i> PDF scaricato. Salvataggio riepilogo in corso...`;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
              alertDiv.classList.remove("show");
              alertDiv.classList.add("fade");
              setTimeout(() => alertDiv.remove(), 400);
            }, 3000);

            let csvContent =
              "DocenteAssente,Ora,Sostituto,Classe,Tipo,Origine,Disabled\n";

            const summaryRows = summaryTable.querySelectorAll("tbody tr");

            summaryRows.forEach((row) => {
              const absentTeacher = row.cells[0].innerText.trim();
              row.querySelectorAll("td[data-hour]").forEach((cell) => {
                const hour = cell.dataset.hour;
                const cellContent = cell.innerHTML.trim();
                if (!cellContent) return;

                let tipo = "SOSTITUZIONE";
                let origine = "";
                let disabled = "FALSE";
                let sostituto = "";
                let className = "";

                if (cellContent.includes("Permesso orario"))
                  tipo = "PERMESSO_ORARIO";
                if (cellContent.includes("POT")) tipo = "POTENZIAMENTO";
                if (cellContent.toLowerCase().includes("in compresenza"))
                  tipo = "COMPRESENZA";

                const parts = cellContent.split("<br>");
                sostituto = parts[0].replace(/<.*?>/g, "").trim();
                if (parts[1]) className = parts[1].replace(/[()]/g, "").trim();

                // Determina origine e disabilitazione dal DOM
                const select = document.querySelector(
                  `select[data-absent='${absentTeacher}'][data-hour='${hour}']`
                );
                const input = document.querySelector(
                  `input.manual-pot[data-absent='${absentTeacher}'][data-hour='${hour}']`
                );

                if (select && select.value) origine = "SELECT";
                else if (input && input.value.trim()) origine = "MANUAL";
                else origine = "AUTO";

                if (select && select.disabled) disabled = "TRUE";

                csvContent += `"${absentTeacher}","${hour}","${sostituto}","${className}","${tipo}","${origine}","${disabled}"\n`;
              });
            });

            const giornoSettimana = abbrevMap[dateObj.getUTCDay()];
            const g_csv = String(dateObj.getDate()).padStart(2, "0");
            const m_csv = String(dateObj.getMonth() + 1).padStart(2, "0");
            const a_csv = dateObj.getFullYear();
            const csvFilename = `sostituzioni_${giornoSettimana}-${g_csv}${m_csv}${a_csv}.csv`;
            const remotePath = `${a_csv}/${m_csv}`;
            uploadCsvToServer(csvContent, csvFilename, remotePath);
          }

          if (e.target.closest("#reset-sost-btn")) {
            document.querySelectorAll(".select-pot").forEach((sel) => {
              sel.value = "";
              sel.disabled = false;
            });
            document
              .querySelectorAll(".manual-pot")
              .forEach((input) => (input.value = ""));
            HOURS.forEach(refreshPotVisibilityForHour);
            document
              .querySelectorAll(`#summary-grid td[data-hour]`)
              .forEach((td) => {
                if (!td.dataset.comp && !td.dataset.pot && !td.dataset.permesso)
                  td.innerHTML = "";
              });
            const ok = document.createElement("div");
            ok.className =
              "alert alert-success text-center mt-3 fade show shadow";
            ok.style.position = "fixed";
            ok.style.bottom = "20px";
            ok.style.left = "50%";
            ok.style.transform = "translateX(-50%)";
            ok.style.zIndex = "9999";
            ok.style.minWidth = "280px";
            ok.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i> Sostituzioni resettate con successo`;
            document.body.appendChild(ok);
            setTimeout(() => {
              ok.classList.remove("show");
              ok.classList.add("fade");
              setTimeout(() => ok.remove(), 400);
            }, 3000);
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });

        document.addEventListener("input", function (e) {
          if (e.target.matches(".manual-pot")) {
            const input = e.target;
            const select =
              input.parentElement.querySelector("select.select-pot");
            if (input.value.trim()) {
              if (select) {
                select.value = "";
                select.disabled = true;
              }
              updateSummaryCell(
                input.dataset.absent,
                input.dataset.hour,
                input.value.trim(),
                input.dataset.class
              );
            } else {
              if (select) {
                select.disabled = false;
              }
              updateSummaryCell(
                input.dataset.absent,
                input.dataset.hour,
                "",
                input.dataset.class
              );
            }
            refreshPotVisibilityForHour(input.dataset.hour);
          }
        });

        document.addEventListener("change", function (e) {
          if (e.target.matches(".select-pot")) {
            const select = e.target;
            const input =
              select.parentElement.querySelector("input.manual-pot");
            if (select.value && input) {
              input.value = "";
            }
            updateSummaryCell(
              select.dataset.absent,
              select.dataset.hour,
              select.value || "",
              select.dataset.class
            );
            refreshPotVisibilityForHour(select.dataset.hour);
          }
        });

        loadBtn.addEventListener("click", async () => {
          const selectedDate = dateInput.value;
          if (!selectedDate) return alert("Seleziona una data!");
          resultsContainer.innerHTML = `<div class="alert alert-warning text-center">Lettura dei dati in corso...</div>`;
          await loadOrario();

          const dateObj = new Date(selectedDate);
          const giornoSettimana = abbrevMap[dateObj.getUTCDay()];
          const giornoEsteso = giorniEstesi[dateObj.getUTCDay()];
          const g = String(dateObj.getDate()).padStart(2, "0");
          const m = String(dateObj.getMonth() + 1).padStart(2, "0");
          const a = dateObj.getFullYear();
          const remoteFolder = `${a}/${m}`;
          const fullCsvPath = remoteBaseUrl + csvDataPath;

          const urlAssenze = `${fullCsvPath}${remoteFolder}/assenze_${giornoSettimana}-${g}${m}${a}.csv`;
          const urlPermessi = `${fullCsvPath}${remoteFolder}/permessi_${giornoSettimana}-${g}${m}${a}.csv`;
          const urlSostituzioni = `${fullCsvPath}${remoteFolder}/sostituzioni_${giornoSettimana}-${g}${m}${a}.csv`;

          let assenzeCSV, permessiCSV;
          let savedChoices = new Map();

          try {
            const sostituzioniCSV = await fetchCSV(urlSostituzioni);
            if (!sostituzioniCSV.trim() || sostituzioniCSV.startsWith("<")) {
              throw new Error("File CSV non valido o vuoto.");
            }
            if (
              confirm(
                "√à stato trovato un salvataggio precedente per questa data. Vuoi ripristinarlo?"
              )
            ) {
              const lines = sostituzioniCSV.trim().split("\n").slice(1);
              lines.forEach((line) => {
                const values = line
                  .match(/(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\",]+))/g)
                  .map((v) =>
                    v.replace(/^"|"$/g, "").replace(/""/g, '"').trim()
                  );
                if (values.length >= 7) {
                  const [
                    Docente,
                    Ora,
                    Sostituto,
                    Classe,
                    Tipo,
                    Origine,
                    Disabled,
                  ] = values;
                  savedChoices.set(`${Docente}|${Ora}`, {
                    Sostituto,
                    Classe,
                    Tipo,
                    Origine,
                    Disabled: Disabled === "TRUE",
                  });
                }
              });
              console.log(
                "Sostituzioni precedentemente salvate caricate e pronte per il ripristino."
              );
            } else {
              console.log(
                "L'utente ha scelto di non ripristinare il salvataggio precedente."
              );
            }
          } catch (err) {
            console.log(
              "Nessun file di sostituzioni salvato trovato per questa data. Si proceder√† con una configurazione vuota."
            );
          }

          try {
            assenzeCSV = await fetchCSV(urlAssenze);
          } catch (err) {
            resultsContainer.innerHTML = `<div class="alert alert-danger text-center"><strong>Impossibile procedere:</strong> informazioni su assenze giornaliere per la data selezionata non presenti sul server!</div>`;
            return;
          }

          try {
            permessiCSV = await fetchCSV(urlPermessi);
          } catch (err) {
            resultsContainer.innerHTML = `<div class="alert alert-danger text-center"><strong>Impossibile procedere:</strong> informazioni su assenze orarie per la data selezionata non presenti sul server!</div>`;
            return;
          }

          try {
            const assenzeLines = parseCSVText(assenzeCSV);
            const assenzeGiornaliere = assenzeLines.map((raw) => {
              const cleanName = String(raw || "")
                .replace(/^\"|\"$/g, "")
                .trim();
              const lezioni = scheduleData.filter(
                (r) =>
                  (r.Docente || "").trim() === cleanName &&
                  normalizzaGiorno(r.Giorno) === normalizzaGiorno(giornoEsteso)
              );
              const dettagli = lezioni.map((l) => ({
                OraInizio: l.OraInizio,
                OraFine: l.OraFine,
                Classe: l.Classe,
              }));
              return { nome: cleanName, dettagli };
            });

            const permLines = parseCSVText(permessiCSV);
            const assenzeOrarie = permLines
              .map((line) => {
                const m = String(line || "")
                  .trim()
                  .replace(/\r/g, "")
                  .match(/^\"?(.*?)\"?\s*,\s*\"?(.+?)\"?$/);
                if (!m) return null;
                const docente = m[1].trim().replace(/^\"|\"$/g, "");
                const oreRaw = m[2].trim();
                const oreArray = oreRaw
                  .split(",")
                  .map((o) => o.replace(/\"/g, "").trim())
                  .filter(Boolean);
                return { nome: docente, ora: oreArray.join(", ") };
              })
              .filter(Boolean);

            displayTables(
              assenzeGiornaliere,
              assenzeOrarie,
              selectedDate,
              giornoEsteso,
              savedChoices
            );
          } catch (err) {
            console.error("Errore nel parsing dei dati:", err);
            resultsContainer.innerHTML = `<div class="alert alert-danger text-center">Errore nell'elaborazione dei dati CSV: ${err.message}</div>`;
          }
        });
      });
    </script>
  </body>
</html>
