<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PitaSOS</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
      body {
        font-family: "Nunito", sans-serif;
        background-color: #f8f9fa;
        padding: 1rem;
      }
      .main-container {
        max-width: 950px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        font-weight: 700;
        color: #0d6efd;
        margin-bottom: 1.5rem;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .table th,
      .table td {
        vertical-align: middle !important;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Intestazione PitaSOS -->
      <div class="text-center mt-4 mb-4">
        <i
          class="bi bi-person-lines-fill text-primary"
          style="font-size: 3rem"
        ></i>
        <h1 class="fw-bold mb-1 mt-2">PitaSOS</h1>
        <p class="text-muted fst-italic mb-0">
          Versione per chi si occupa delle sostituzioni
        </p>
      </div>

      <!-- Selezione Data -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white fw-semibold">
          1. Seleziona la data
        </div>
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row align-items-md-end gap-3">
            <div class="flex-fill">
              <label for="date-input" class="form-label fw-semibold"
                >Data:</label
              >
              <input type="date" class="form-control" id="date-input" />
            </div>
            <div>
              <button id="load-btn" class="btn btn-primary px-4">
                <i class="bi bi-download"></i> Leggi dati
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Risultati -->
      <div id="results-container">
        <div class="alert alert-info text-center mb-0">
          I risultati verranno mostrati qui dopo la lettura dei dati.
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.getElementById("date-input");
        const loadBtn = document.getElementById("load-btn");
        const resultsContainer = document.getElementById("results-container");

        // Imposta la data odierna come predefinita
        const oggi = new Date();
        const yyyy = oggi.getFullYear();
        const mm = String(oggi.getMonth() + 1).padStart(2, "0");
        const dd = String(oggi.getDate()).padStart(2, "0");
        dateInput.value = `${yyyy}-${mm}-${dd}`;

        const csvBase = "https://progetti.antoniofittipaldi.it/pitasos/";
        const corsProxy = "https://api.allorigins.win/raw?url=";
        const orarioFile = "orario.csv";
        const abbrevMap = ["dom", "lun", "mar", "mer", "gio", "ven", "sab"];
        const giorniEstesi = [
          "Domenica",
          "LunedÃ¬",
          "MartedÃ¬",
          "MercoledÃ¬",
          "GiovedÃ¬",
          "VenerdÃ¬",
          "Sabato",
        ];
        let scheduleData = [];

        // --- Utility per leggere CSV in sicurezza ---
        async function fetchCSV(url) {
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.text();
          } catch {
            const proxyResponse = await fetch(
              corsProxy + encodeURIComponent(url)
            );
            if (!proxyResponse.ok)
              throw new Error(`Proxy ${proxyResponse.status}`);
            return await proxyResponse.text();
          }
        }

        // --- Carica orario ---
        async function loadOrario() {
          const text = await fetch(orarioFile).then((r) => r.text());
          const lines = text.trim().split("\n");
          const headers = lines[0].split(",").map((h) => h.trim());
          scheduleData = lines.slice(1).map((line) => {
            const values = line.split(",");
            return headers.reduce((obj, header, i) => {
              obj[header] = values[i]
                ? values[i].trim().replace(/^"|"$/g, "")
                : "";
              return obj;
            }, {});
          });
        }

        // --- Parsing righe ---
        function parseCSVText(text) {
          return text
            .trim()
            .split("\n")
            .slice(1) // Salta intestazione
            .map((r) => r.replace("\r", "").trim().replace(/^"|"$/g, ""))
            .filter(Boolean);
        }

        // --- Normalizza stringhe (giorni con accenti, ecc.) ---
        const normalizzaGiorno = (g) =>
          (g || "")
            .toString()
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

        // --- Mostra risultati ---
        function displayTables(
          assenzeGiornaliere,
          assenzeOrarie,
          selectedDate,
          giornoEsteso
        ) {
          const dateObj = new Date(selectedDate);
          const giorno = String(dateObj.getDate()).padStart(2, "0");
          const mese = String(dateObj.getMonth() + 1).padStart(2, "0");
          const anno = dateObj.getFullYear();

          // ðŸ”¹ Docenti POT del giorno
          const potSlots = scheduleData.filter((r) => {
            const giornoRow = (r.Giorno || "").toString();
            const classeRow = (r.Classe || "").toString();
            return (
              normalizzaGiorno(giornoRow) === normalizzaGiorno(giornoEsteso) &&
              classeRow.toLowerCase().includes("pot")
            );
          });

          const potDocenti = [...new Set(potSlots.map((r) => r.Docente.trim()))]
            .filter((d) => d.toUpperCase() !== "COLLETTA O.")
            .sort();

          console.log("ðŸ“‹ Docenti POT trovati:", potDocenti);

          // Funzione per verificare compresenza
          function isCompresenza(
            classe,
            oraInizio,
            oraFine,
            docente,
            assenzeGiornaliere = [],
            assenzeOrarie = []
          ) {
            // Se manca scheduleData o giornoEsteso, esci subito
            if (!Array.isArray(scheduleData) || !giornoEsteso) return false;

            // Normalizza i dati e trova eventuali compresenti
            const compresenti = scheduleData.filter(
              (r) =>
                r &&
                normalizzaGiorno(r.Giorno || "") ===
                  normalizzaGiorno(giornoEsteso) &&
                r.Classe?.trim() === classe?.trim() &&
                r.OraInizio === oraInizio &&
                r.OraFine === oraFine &&
                r.Docente?.trim() !== docente?.trim()
            );

            if (compresenti.length === 0) return false; // nessuna compresenza trovata

            // Assicurati che le liste di assenze siano sempre array
            const assenzeG = Array.isArray(assenzeGiornaliere)
              ? assenzeGiornaliere
              : [];
            const assenzeO = Array.isArray(assenzeOrarie) ? assenzeOrarie : [];

            // Controlla se tutti i compresenti sono assenti (giornalmente o orariamente)
            const tuttiAssenti = compresenti.every((c) => {
              const nome = c.Docente?.trim() || "";
              return (
                assenzeG.some((a) => a.nome === nome) ||
                assenzeO.some(
                  (a) => a.nome === nome && a.ora === `${oraInizio}-${oraFine}`
                )
              );
            });

            // true solo se almeno uno dei compresenti Ã¨ presente â†’ quindi effettiva compresenza
            return !tuttiAssenti;
          }

          // --- COSTRUZIONE SEZIONI PRINCIPALI ---
          let html = `
    <!-- ðŸŸ¦ ASSENZE GIORNALIERE -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white fw-bold">
        Assenze giornaliere â€” ${giorno}/${mese}/${anno}
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="bg-primary text-white">
              <tr><th style="width:25%;">Docente</th><th>Ore di Assenza / Sostituti (POT)</th></tr>
            </thead>
            <tbody>
  `;

          const summaryRows = []; // per riepilogo finale

          // --- Sezione: Assenze giornaliere ---
          if (assenzeGiornaliere.length > 0) {
            assenzeGiornaliere.forEach((a) => {
              let oreHTML = "";
              a.dettagli.forEach((det, idx) => {
                const separatore = idx > 0 ? `<hr class="my-2">` : "";

                const comp = isCompresenza(
                  det.Classe,
                  det.OraInizio,
                  det.OraFine,
                  a.nome
                );
                let potHTML = "";

                if (comp) {
                  potHTML = `<span class="fst-italic text-secondary">In compresenza</span>`;
                  summaryRows.push({
                    docente: a.nome,
                    classe: det.Classe,
                    ora: `${det.OraInizio}-${det.OraFine}`,
                    sostituto: "In compresenza",
                  });
                } else {
                  const potDisponibili = potSlots
                    .filter(
                      (p) =>
                        p.OraInizio === det.OraInizio &&
                        p.OraFine === det.OraFine
                    )
                    .map((p) => p.Docente)
                    .filter((p) => p !== a.nome);

                  potHTML = potDisponibili.length
                    ? potDisponibili
                        .map(
                          (p) => `
                  <div class="form-check form-check-inline me-3 sub-option"
                       data-hour="${det.OraInizio}-${det.OraFine}"
                       data-sub="${p}">
                    <input class="form-check-input sub-check" type="radio"
                           name="pot-${a.nome}-${det.OraInizio.replace(
                            ":",
                            ""
                          )}"
                           value="${p}" data-absent="${a.nome}" data-class="${
                            det.Classe
                          }"
                           data-hour="${det.OraInizio}-${det.OraFine}">
                    <label class="form-check-label small">${p}</label>
                  </div>
                `
                        )
                        .join("")
                    : `<span class="text-muted fst-italic">Nessun POT disponibile</span>`;
                }

                oreHTML += `
          ${separatore}
          <div class="mb-2">
            <strong>${det.OraInizio}-${det.OraFine}</strong> (${det.Classe})<br>
            ${potHTML}
          </div>`;
              });

              html += `
        <tr>
          <td><i class="bi bi-person-fill me-1 text-primary"></i><strong>${a.nome}</strong></td>
          <td>${oreHTML}</td>
        </tr>`;
            });
          } else {
            html += `<tr><td colspan="2" class="text-center text-muted">Nessuna assenza giornaliera trovata</td></tr>`;
          }

          html += `
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ðŸŸ¦ ASSENZE ORARIE (stesso colore) -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white fw-bold">
        Assenze orarie â€” ${giorno}/${mese}/${anno}
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="bg-primary text-white">
              <tr><th style="width:25%;">Docente</th><th>Orario / Classe / Sostituti (POT)</th></tr>
            </thead>
            <tbody>
  `;

          // --- Sezione: Assenze orarie ---
          if (assenzeOrarie.length > 0) {
            assenzeOrarie.forEach((a) => {
              const [oraInizio, oraFine] = a.ora.split("-");
              const comp = isCompresenza(a.classe, oraInizio, oraFine, a.nome);
              let potHTML = "";

              if (comp) {
                potHTML = `<span class="fst-italic text-secondary">In compresenza</span>`;
                summaryRows.push({
                  docente: a.nome,
                  classe: a.classe,
                  ora: a.ora,
                  sostituto: "In compresenza",
                });
              } else {
                const potDisponibili = potSlots
                  .filter(
                    (p) => p.OraInizio === oraInizio && p.OraFine === oraFine
                  )
                  .map((p) => p.Docente)
                  .filter((p) => p !== a.nome);

                potHTML = potDisponibili.length
                  ? potDisponibili
                      .map(
                        (p) => `
                <div class="form-check form-check-inline me-3 sub-option"
                     data-hour="${a.ora}"
                     data-sub="${p}">
                  <input class="form-check-input sub-check" type="radio"
                         name="pot-${a.nome}-${a.ora
                          .replace(":", "")
                          .replace("-", "")}"
                         value="${p}" data-absent="${a.nome}" data-class="${
                          a.classe
                        }"
                         data-hour="${a.ora}">
                  <label class="form-check-label small">${p}</label>
                </div>
              `
                      )
                      .join("")
                  : `<span class="text-muted fst-italic">Nessun POT disponibile</span>`;
              }

              html += `
        <tr>
          <td><i class="bi bi-person-fill me-1 text-primary"></i><strong>${a.nome}</strong></td>
          <td>
            <strong>${a.ora}</strong> (${a.classe})<br>
            ${potHTML}
          </td>
        </tr>`;
            });
          } else {
            html += `<tr><td colspan="2" class="text-center text-muted">Nessuna assenza oraria trovata</td></tr>`;
          }

          html += `
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ðŸ§¾ RIEPILOGO (verde) -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white fw-bold">Riepilogo Sostituzioni</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0 align-middle" id="summary-table">
            <thead class="bg-success text-white">
              <tr><th>Docente Assente</th><th>Classe</th><th>Orario</th><th>Sostituto</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="mb-3">
  <label for="notes" class="form-label">Note (facoltative):</label>
  <textarea id="notes" class="form-control" rows="2"></textarea>
</div>
    <!-- Pulsanti di azione -->
<div class="text-center mb-5">
  <button id="reset-sost-btn" class="btn btn-outline-danger me-2">
    <i class="bi bi-trash3"></i> Resetta sostituzioni
  </button>
  <button id="export-pdf-btn" class="btn btn-outline-primary">
    <i class="bi bi-file-earmark-pdf"></i> Esporta PDF
  </button>
</div>
  `;

          resultsContainer.innerHTML = html;

          const summaryBody = document.querySelector("#summary-table tbody");

          // Inserisci subito le righe "In compresenza"
          summaryRows.forEach((r) => {
            const row = document.createElement("tr");
            row.innerHTML = `
      <td>${r.docente}</td>
      <td>${r.classe}</td>
      <td>${r.ora}</td>
      <td><em>${r.sostituto}</em></td>`;
            summaryBody.appendChild(row);
          });

          // --- GESTIONE SELEZIONI POT (dinamiche) ---
          resultsContainer.addEventListener("change", (event) => {
            if (!event.target.classList.contains("sub-check")) return;
            const radio = event.target;
            const sub = radio.value;
            const hour = radio.dataset.hour;
            const absent = radio.dataset.absent;
            const classe = radio.dataset.class;

            // Rimuovi riga precedente (stesso docente/ora)
            const existing = summaryBody.querySelector(
              `tr[data-key="${absent}_${hour}"]`
            );
            if (existing) existing.remove();

            // Aggiungi riga aggiornata
            const newRow = document.createElement("tr");
            newRow.dataset.key = `${absent}_${hour}`;
            newRow.innerHTML = `
      <td>${absent}</td>
      <td>${classe}</td>
      <td>${hour}</td>
      <td>${sub}</td>`;
            summaryBody.appendChild(newRow);

            // Ordina il riepilogo per ora
            const rows = Array.from(summaryBody.querySelectorAll("tr"));
            rows.sort((a, b) => {
              const ha = a.children[2].innerText.split("-")[0];
              const hb = b.children[2].innerText.split("-")[0];
              return ha.localeCompare(hb);
            });
            summaryBody.innerHTML = "";
            rows.forEach((r) => summaryBody.appendChild(r));

            // Nascondi docente POT selezionato altrove per la stessa ora
            document
              .querySelectorAll(
                `.sub-option[data-hour="${hour}"][data-sub="${sub}"]`
              )
              .forEach((opt) => {
                const input = opt.querySelector(".sub-check");
                if (!input.checked) opt.style.display = "none";
              });

            // Se cambia selezione â†’ ripristina
            const gruppo = document.getElementsByName(radio.name);
            gruppo.forEach((el) => {
              el.addEventListener("change", () => {
                document
                  .querySelectorAll(`.sub-option[data-hour="${hour}"]`)
                  .forEach((opt) => (opt.style.display = "inline-block"));
              });
            });
          });
        }

        // --- Pulsante Reset Sostituzioni ---
        // --- Pulsante Reset (mantiene "In compresenza") ---
        // --- Pulsante Reset (mantiene "In compresenza" e mostra conferma) ---
        // --- Pulsante Reset (mantiene "In compresenza" e mostra conferma con icona) ---
        document.addEventListener("click", (e) => {
          if (e.target.id === "reset-sost-btn") {
            // Deseleziona tutti i radio
            document
              .querySelectorAll(".sub-check")
              .forEach((cb) => (cb.checked = false));
            document
              .querySelectorAll(".sub-option")
              .forEach((opt) => (opt.style.display = "inline-block"));

            // Rimuove solo le righe non "In compresenza"
            const summaryBody = document.querySelector("#summary-table tbody");
            if (summaryBody) {
              summaryBody.querySelectorAll("tr").forEach((row) => {
                const lastCellText = (row.lastElementChild?.textContent || "")
                  .trim()
                  .toLowerCase();
                if (!lastCellText.includes("in compresenza")) {
                  row.remove();
                }
              });
            }

            // ðŸ”¹ Messaggio di conferma (Bootstrap + icona)
            const alertDiv = document.createElement("div");
            alertDiv.className =
              "alert alert-success text-center mt-3 fade show shadow";
            alertDiv.style.position = "fixed";
            alertDiv.style.bottom = "20px";
            alertDiv.style.left = "50%";
            alertDiv.style.transform = "translateX(-50%)";
            alertDiv.style.zIndex = "9999";
            alertDiv.style.minWidth = "280px";
            alertDiv.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i> Sostituzioni resettate con successo`;
            document.body.appendChild(alertDiv);

            // Rimuove lâ€™alert dopo 3 secondi
            setTimeout(() => {
              alertDiv.classList.remove("show");
              alertDiv.classList.add("fade");
              setTimeout(() => alertDiv.remove(), 400);
            }, 3000);

            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });

        // --- Pulsante Esporta PDF ---
        // --- Esporta PDF (landscape + paginazione centrata + note piccole + corsivo "In compresenza")
        // --- Esporta PDF (landscape + paginazione centrata + note piccole + conferma) ---
        // --- Esporta PDF (landscape + paginazione centrata + note piccole + conferma con icona) ---
        document.addEventListener("click", (e) => {
          const exportBtn = e.target.closest("#export-pdf-btn");
          if (!exportBtn) return;

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: "landscape" });

          const dateEl = document.getElementById("date-input");
          const dateObj =
            dateEl && dateEl.value ? new Date(dateEl.value) : new Date();
          const dataFmt = dateObj.toLocaleDateString("it-IT", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          doc.setFontSize(14);
          doc.text(`Sostituzioni del giorno ${dataFmt}`, 14, 15);

          doc.autoTable({
            html: "#summary-table",
            startY: 25,
            theme: "grid",
            headStyles: {
              fillColor: [25, 135, 84],
              textColor: [255, 255, 255],
            },
            styles: {
              fontSize: 10,
              cellPadding: 3,
              lineColor: [222, 226, 230],
              lineWidth: 0.2,
              textColor: [33, 37, 41],
            },
            didParseCell: (data) => {
              const txt =
                data.cell.text && data.cell.text[0]
                  ? data.cell.text[0].toLowerCase()
                  : "";
              if (txt.includes("in compresenza")) {
                data.cell.styles.fontStyle = "italic";
                data.cell.styles.textColor = [108, 117, 125];
              }
            },
            didDrawPage: (data) => {
              const pageCount = doc.getNumberOfPages();
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();
              const footer = `Pagina ${data.pageNumber} / ${pageCount}`;
              doc.setFontSize(10);
              doc.setTextColor(150);
              const textWidth = doc.getTextWidth(footer);
              const xCenter = (pageWidth - textWidth) / 2;
              doc.text(footer, xCenter, pageHeight - 10);
            },
            margin: { top: 25, left: 10, right: 10 },
          });

          // Note (se presenti)
          const notesEl = document.getElementById("notes");
          const notesText = notesEl ? notesEl.value.trim() : "";
          if (notesText) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y =
              (doc.lastAutoTable && doc.lastAutoTable.finalY
                ? doc.lastAutoTable.finalY
                : 25) + 10;
            if (y > pageHeight - 20) {
              doc.addPage();
              y = 20;
            }
            doc.setFontSize(9);
            doc.setTextColor(90);
            const wrapped = doc.splitTextToSize(notesText, pageWidth - 28);
            doc.text(wrapped, 14, y);
          }

          const y = String(dateObj.getFullYear());
          const m = String(dateObj.getMonth() + 1).padStart(2, "0");
          const d = String(dateObj.getDate()).padStart(2, "0");
          const filename = `riepilogo_sostituzioni_${y}${m}${d}.pdf`;
          doc.save(filename);

          // ðŸ”¹ Messaggio di conferma con icona
          const alertDiv = document.createElement("div");
          alertDiv.className =
            "alert alert-primary text-center mt-3 fade show shadow";
          alertDiv.style.position = "fixed";
          alertDiv.style.bottom = "20px";
          alertDiv.style.left = "50%";
          alertDiv.style.transform = "translateX(-50%)";
          alertDiv.style.zIndex = "9999";
          alertDiv.style.minWidth = "280px";
          alertDiv.innerHTML = `<i class="bi bi-file-earmark-check-fill me-2"></i> PDF generato correttamente`;
          document.body.appendChild(alertDiv);

          setTimeout(() => {
            alertDiv.classList.remove("show");
            alertDiv.classList.add("fade");
            setTimeout(() => alertDiv.remove(), 400);
          }, 3000);
        });

        // --- Leggi dati remoti e mostra ---
        loadBtn.addEventListener("click", async () => {
          const selectedDate = dateInput.value;
          if (!selectedDate) return alert("Seleziona una data!");
          resultsContainer.innerHTML = `<div class="alert alert-warning text-center">Lettura dei dati in corso...</div>`;

          await loadOrario();

          const dateObj = new Date(selectedDate);
          const giorno = String(dateObj.getDate()).padStart(2, "0");
          const mese = String(dateObj.getMonth() + 1).padStart(2, "0");
          const anno = dateObj.getFullYear();
          const giornoSettimana = abbrevMap[dateObj.getUTCDay()];
          const giornoEsteso = giorniEstesi[dateObj.getUTCDay()];
          const meseFolder = `${mese}`;

          const urlAssenze = `${csvBase}${meseFolder}/assenze_${giornoSettimana}-${giorno}${mese}${anno}.csv`;
          const urlPermessi = `${csvBase}${meseFolder}/permessi_${giornoSettimana}-${giorno}${mese}${anno}.csv`;

          try {
            const [assenzeCSV, permessiCSV] = await Promise.all([
              fetchCSV(urlAssenze),
              fetchCSV(urlPermessi),
            ]);

            const assenze = parseCSVText(assenzeCSV);
            const permessi = parseCSVText(permessiCSV);

            const assenzeGiornaliere = assenze.map((nome) => {
              const cleanName = nome.replace(/^"|"$/g, "").trim();
              const lezioni = scheduleData.filter(
                (r) =>
                  r.Docente === cleanName &&
                  normalizzaGiorno(r.Giorno) === normalizzaGiorno(giornoEsteso)
              );
              const dettagli = lezioni.map((l) => ({
                OraInizio: l.OraInizio,
                OraFine: l.OraFine,
                Classe: l.Classe,
              }));
              return { nome: cleanName, dettagli };
            });

            const assenzeOrarie = permessi.flatMap((linea) => {
              const parts = linea.split(",");
              const cleanName = parts[0].replace(/^"|"$/g, "").trim();
              const oraAssenza = parts[1] ? parts[1].trim() : "";
              const lezioni = scheduleData.filter(
                (r) =>
                  r.Docente === cleanName &&
                  normalizzaGiorno(r.Giorno) ===
                    normalizzaGiorno(giornoEsteso) &&
                  `${r.OraInizio}-${r.OraFine}` === oraAssenza
              );
              return lezioni.length
                ? lezioni.map((l) => ({
                    nome: cleanName,
                    ora: oraAssenza,
                    classe: l.Classe,
                  }))
                : [{ nome: cleanName, ora: oraAssenza || "-", classe: "-" }];
            });

            displayTables(
              assenzeGiornaliere,
              assenzeOrarie,
              selectedDate,
              giornoEsteso
            );
          } catch (error) {
            console.error(error);
            resultsContainer.innerHTML = `<div class="alert alert-danger text-center">Errore nella lettura dei file CSV: ${error.message}</div>`;
          }
        });
      });
    </script>
  </body>
</html>
